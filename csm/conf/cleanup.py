# CORTX-CSM: CORTX Management web and CLI interface.
# Copyright (c) 2020 Seagate Technology LLC and/or its Affiliates
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
# You should have received a copy of the GNU Affero General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
# For any questions about this software or licensing,
# please email opensource@seagate.com or cortx-questions@seagate.com.

import importlib
from pydoc import locate
from csm.conf.setup import Setup, CsmSetupError
from csm.conf.uds import UDSConfigGenerator
from cortx.utils.log import Log
from cortx.utils.conf_store.conf_store import Conf
from cortx.utils.kv_store.error import KvError
from cortx.utils.data.db.db_provider import (DataBaseProvider, GeneralConfig)
from cortx.utils.errors import DataAccessExternalError
from csm.core.blogic import const
from csm.common.payload import Yaml
from csm.core.providers.providers import Response
from csm.common.errors import CSM_OPERATION_SUCESSFUL

class Cleanup(Setup):
    """
    Cleanup all the Files and Folders generated by csm.
    """
    def __init__(self):
        super(Cleanup, self).__init__()
        Log.info("Running Cleanup for CSM.")
        self._db = None

    async def execute(self, command):
        try:
            Conf.load(const.CSM_GLOBAL_INDEX, const.CSM_SOURCE_CONF_URL)
            Conf.load(const.DATABASE_INDEX, f"yaml://{const.DATABASE_CONF}")
        except KvError as e:
            Log.error(f"Loading csm.conf to conf store failed {e}")
            raise CsmSetupError("Failed to Load CSM Configuration File.")
        self._log_cleanup()
        UDSConfigGenerator.delete()
        self.load_db()
        self.directory_cleanup()
        return Response(output=const.CSM_SETUP_PASS, rc=CSM_OPERATION_SUCESSFUL)

    def _log_cleanup(self):
        """
        Delete all logs
        """
        Log.info("Delete all logs")
        log_path = Conf.get(const.CSM_GLOBAL_INDEX, "Log>log_path")
        Setup._run_cmd("rm -rf " +log_path)

    def load_db(self):
        """
        Load Database Provider from database.yaml
        :return:
        """
        Log.info("Loading Database Provider.")
        conf = GeneralConfig(Yaml(const.DATABASE_CLI_CONF).load())
        self._db = DataBaseProvider(conf)

    def _db_cleanup(self):
        """
        :return:
        """
        for each_model in Conf.get(const.DATABASE_INDEX, "models"):
                self.erase_collection(each_model.get("collection"))

    def erase_collection(self, collection_details):
        """
        Clean up all the CSM Elasticsearch Data.
        :param collection_details: Elasticsearch Collection Name to be Deleted.
        :return:
        """
        Log.info(f"Cleaning up Elasticsearch Collection {collection_details}")
        model_path, model_name = collection_details[
            "import_path"].rsplit(".", 1)
        module = importlib.import_module(model_path)
        db_model = getattr(module, model_name)(self._db)
        db_model.delete()

    def selective_cleanup(self, collection_details):
        """
        Cleanup all the CSM Consul Data.
        :param collection_details: Consul Collection Name to be Deleted.
        :return:
        """
        Log.info(f"Cleaning up Collection {collection_details}")

    def directory_cleanup(self):
        """
        Delete local Directories as Follows:
        /etc/csm
        /var/log/seagate/csm
        /var/log/seagate/support_bundle
        /tmp/csm
        /tmp/hotfix
        :return:
        """
        self.Config.delete()
        for each_directory in const.CLEANUP_DIRECTORIES:
            Log.info(f"Deleting Directory {each_directory}")
            Setup._run_cmd(f"rm -rf {each_directory}")


